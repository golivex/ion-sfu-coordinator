version: "3.7"

services:
    etcd:
        image: gcr.io/etcd-development/etcd:v3.4.9
        entrypoint: "/usr/local/bin/etcd"
        command: "--listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://0.0.0.0:2379"
        network_mode: host
        # ports:
        #     - 2379:2379

    # server:
    #     container_name: server
    #     build:
    #         context : ./server
    #     image: xtechsample/server-ion:latest
    #     restart: always
    #     environment:
    #         - ETCD=http://0.0.0.0:2379
    #         - LEASE_TEMP_TIMEOUT=5
    #         - MAX_GCP_INSTANCES=0 # max number of gcp instances we can start
    #         - MY_IP=5.9.18.28
    #         - AUTO_SCALE_TIMEOUT=5000 # how long to wait before auto scaling starts
    #         - GCP_DEAD_HOST_DELETE_WAIT=60 # how long to wait in sec before deleting a dead server
    #         - GCP_EMPTY_SESSION_DELETE_WAIT=30 # how to long to wait in sec before deleting a empty session server
    #         - MINIMUM_HOSTS=1
    #     network_mode: host
    #     depends_on:
    #         - etcd

    actions:
        build:
            context : pion-tools/actions
        restart: always
        network_mode: host

    prometheus:
        image: prom/prometheus:latest
        # ports:
        #     - 9090:9090
        network_mode: host
        volumes:
            - "./cfgs/prometheus.yml:/etc/prometheus/prometheus.yml"

    
    sfu:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7002", "-gaddr" , ":50052", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8100"]
        volumes:
            - "./cfgs/sfuA.toml:/configs/sfu.toml"
        network_mode: host
        # ports:
        #     - "10000-11000:10000-11000/udp"
        #     - 7001:7001
            

    sfuB:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7003", "-gaddr" , ":50053", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8102"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    sfuB-1:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7004", "-gaddr" , ":50054", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8103"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    sfuB-2:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7005", "-gaddr" , ":50055", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8104"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    sfuB-3:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7006", "-gaddr" , ":50056", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8105"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    sfuB-4:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7007", "-gaddr" , ":50057", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8106"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    sfuB-5:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7008", "-gaddr" , ":50058", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8107"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host
    
    sfuB-6:
        image: xtechsample/ion-sfu:latest-allrpc
        build: 
            context: ./ion-sfu
            dockerfile: cmd/signal/allrpc/Dockerfile
        command: ["-c", "/configs/sfu.toml", "-jaddr", ":7009", "-gaddr" , ":50059", "-eaddr", "0.0.0.0:2379", "-ipaddr", "5.9.18.28", "-maddr", ":8108"]
        volumes:
            - "./cfgs/sfuB.toml:/configs/sfu.toml"
        network_mode: host

    # caddy:
    #     image: caddy:2.3.0-alpine
    #     restart: unless-stopped
    #     ports:
    #         - "85:80"
    #         - "445:443"
    #     volumes:
    #         - ./caddy/Caddyfile:/etc/caddy/Caddyfile